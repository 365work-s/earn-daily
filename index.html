<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Repository</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        #professor-corner-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        #video-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .video-container {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative; 
        }
        .video-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .video-embed-wrapper {
            position: relative;
            padding-bottom: 75%; 
            height: 0;
            overflow: hidden;
        }
        .video-embed-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        /* Click Overlay to reliably capture the click and log data */
        .click-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Above the iframe */
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <h1>Video Repository</h1>
        <a id="professor-corner-btn" target="_blank">Professor Corner (Submit Video)</a>
    </header>

    <div id="loading">Loading videos...</div>
    <div id="video-gallery">
        </div>

    <script>
        // *** YOUR DEPLOYED GOOGLE APPS SCRIPT URL ***
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyndHkEMiG4-B6pFuw6pEqnXABmOIq3UE_cFOBLvNbJ7AtRC2Iahw__ZB-MBopbjlbI/exec"; 
        
        // Your Google Form URL
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeOnHCD_rzoKXUL_fePHGcq3HqFhKPAkkl5hth0YLMMYm3vA/viewform"; // Assuming this is your form view link

        document.getElementById('professor-corner-btn').href = GOOGLE_FORM_URL;

        // --- User ID Logic (Persists across sessions/reloads) ---
        function getUserId() {
            let userId = localStorage.getItem('userUniqueId');
            if (!userId) {
                // Generate a simple unique ID
                userId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('userUniqueId', userId);
            }
            return userId;
        }
        const uniqueId = getUserId();
        
        // --- API Interaction Functions ---

        async function fetchVideos() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            } catch (error) {
                console.error("Could not fetch videos:", error);
                document.getElementById('loading').textContent = "Failed to load videos. Check the Google Apps Script deployment URL.";
                return [];
            }
        }

        async function logClick(uniqueKey) {
            
            try {
                // Send the unique video key (Video Title) and the user ID to the Apps Script API
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        uniqueKey: uniqueKey,
                        userId: uniqueId
                    })
                });
            } catch (error) {
                console.error("Failed to log click:", error);
            }
        }

        function renderVideos(videos) {
            const gallery = document.getElementById('video-gallery');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';

            if (videos.length === 0) {
                gallery.innerHTML = '<p>No videos available yet. Use the Professor Corner button to add one!</p>';
                return;
            }

            videos.forEach(video => {
                const container = document.createElement('div');
                container.className = 'video-container';
                
                // The unique key is the Video Title from the sheet, used for tracking
                const uniqueKey = video.uniqueKey; 
                
                const title = document.createElement('div');
                title.className = 'video-title';
                title.textContent = video.title;

                const embedWrapper = document.createElement('div');
                embedWrapper.className = 'video-embed-wrapper';
                embedWrapper.innerHTML = video.embedCode; 
                
                // --- Add a transparent overlay to capture clicks reliably ---
                const overlay = document.createElement('div');
                overlay.className = 'click-overlay';
                overlay.title = "Click to view video and log data";
                
                // Add the click listener to the overlay
                overlay.addEventListener('click', () => {
                    logClick(uniqueKey);
                    // To interact with the video player after logging, 
                    // you typically need to remove or hide the overlay here.
                    // For this simple tracking, we'll keep it simple.
                });


                container.appendChild(title);
                container.appendChild(overlay); // Overlay on top of iframe
                container.appendChild(embedWrapper);
                gallery.appendChild(container);
            });
        }

        // --- Initialization ---
        fetchVideos().then(renderVideos);
    </script>
</body>
</html>
